{% extends "template.html" %}

{% block body %}

    <div class="container">
        <form id="cutouts_form" class="form" method="post">
            {% for objz in classifications %}
                {% for obj in objz %}
                    <div class="form-group row">
                        <div class="col-12">
                            <b>{{obj}}</b>
                        </div>
                        <div class="col-6">
                            <img src="/data/datasets/{{-dataset_id-}}/{{obj}}">
                        </div>
                        <div class="col-6">
                            {% for class in classes %}
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" data-id="{{-obj-}}"
                                         value="{{-class-}}"{% if class in objz[obj] %} checked="checked"{% endif %}>
                                  <label class="form-check-label" for="{{-obj-}}_{{-class-}}">
                                      {{ class }}
                                  </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <hr>
                {% endfor %}
            {% endfor %}

            <div class="form-group row">
                <button type="button" class="btn btn-dark btn-sm" id="save">Save</button>&nbsp;&nbsp;
                <button type="button" class="btn btn-dark btn-sm" id="download">Download JSON</button>
            </div>
        </form>

    </div>

{% endblock %}

{% block js %}
    <script>
        function construct_json() {
            var json = {};
            $("input:checkbox").each(function() {
                if ( $(this).is(":checked") ) {
                    {#alert($(this).val());#}
                    if (!json.hasOwnProperty($(this).data("id"))) {
                        json[$(this).data("id")] = [$(this).val()];
                    }
                    else {
                        json[$(this).data("id")].push($(this).val());
                    }
                }
            });
            return json;
        }

        // submit query
        $(document).ready(function() {
            $('#save').click(function () {
                bootbox.confirm({
                    message: "Do you want to save your classifications to DB?",
                    buttons: {
                        cancel: {
                            label: '<i class="fas fa-times"></i> Cancel'
                        },
                        confirm: {
                            label: '<i class="fas fa-check"></i> Confirm'
                        }
                    },
                    callback: function (result) {
                        // console.log('This was logged in the callback: ' + result);
                        // confirmed? emit request to server:
                        if (result) {
                            let json = construct_json();
                            {#$('#cutouts_form').submit();#}
                            $.ajax({
                                type: "POST",
                                url: '/projects/{{-project_id-}}/datasets/{{-dataset_id-}}/classify',
                                data: JSON.stringify(json),
                                success: function(data) {
                                    if (data === 'success') {
                                        showFlashingMessage('Info:', data, 'success');
                                    }
                                    else {
                                        showFlashingMessage('Info:', data, 'danger');
                                    }
                                },
                                error: function(data) {
                                    showFlashingMessage('Info:', data, 'danger');
                                }
                            });
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}